---
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";

export interface ImageData {
  image: string;
  title?: string;
  caption?: string;
}

const { images } = Astro.props;
const imageAssets = import.meta.glob<{ default: ImageMetadata }>('/src/assets/images/*');

// Load gallery images asynchronously
const galleryImages = await Promise.all(
  images.map(async (img: ImageData) => {
    if (!img.image) return null;
    
    const imagePath = img.image.replace("/images/", "/src/assets/images/");
    
    if (imageAssets[imagePath]) {
      const optimizedImage = (await imageAssets[imagePath]()).default;
      return {
        src: optimizedImage,
        title: img.title,
        caption: img.caption
      };
    }
    return null;
  })
);

const validImages = galleryImages.filter(Boolean);
---

<div class="photo-gallery">
  {validImages.map((img) => (
    <figure>
      <div>
        <Image
          src={img.src}
          alt={img.title || ""}
          class="gallery-image"
          width={600}
          height={600}
          widths={[600, 900, 1200]}
          sizes="(max-width: 600px) 100vw, 600px"
        />
        {(img.title || img.caption) && (
        <figcaption>
          {img.title && <div class="image-title">{img.title}</div>}
          {img.caption && <div class="image-caption">{img.caption}</div>}
        </figcaption>
        )}
      </div>
    </figure>
  ))}
</div>

<style>
  @layer components {
    figure {
      margin: 0;
      aspect-ratio: 1 / 1;
      overflow: hidden;
    }
    figure > div {
      position: relative;
      width: 100%;
      height: 100%;
    }
    figcaption {
      position: absolute;
      inset: 0;
      padding: 0.5rem;
      box-sizing: border-box;
      background-color: rgba(0, 0, 0, 0.75);
      display: grid;
      text-align: center;
      place-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    figure:hover figcaption {
      opacity: 1;
    }
    .image-title {
      font-family: var(--ff-heading);
      font-weight: 700;
      color: var(--paper);
      margin-block: 0.5em;
      line-height: 1.2;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
      overflow: hidden;
    }
    .image-caption {
      font-size: 0.9rem;
      display: block;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 5;
      overflow: hidden;
    }
    .photo-gallery {
      gap: 1px;
      display: grid;
      @container (width < 600px) {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        margin-inline-start: calc(var(--padding-x) * -1);
        inline-size: calc(100% + calc(var(--padding-x) * 2));
      }
      @container (width >= 600px) {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }
    }
    .gallery-image {
      inline-size: 100%;
      block-size: 100%;
      object-fit: cover;
      box-sizing: border-box;
    }
  }
</style>
