---
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';
import Button from '../../components/Button.astro';
import Layout from '../../layouts/Layout.astro';
import InteriorPage from '../../components/InteriorPage.astro';
import { SITE_SEO, BASE_URL, ROUTES } from '../../config/site';

export async function getStaticPaths() {
  const posts = await getCollection('gallery');
  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;

const images = import.meta.glob<{ default: ImageMetadata }>('/src/assets/images/**/*');

let optimizedImage;
if (post.data.image) {
  const imagePath = post.data.image.replace('/images/', '/src/assets/images/');
  if (images[imagePath]) {
    optimizedImage = (await images[imagePath]()).default;
  }
}
---

<Layout 
  title={`${post.data.title} | ${SITE_SEO.name.long}`} 
  description={post.data.caption ? post.data.caption : SITE_SEO.description}
>
  <InteriorPage heading={post.data.title} lead={post.data.caption}>
    {optimizedImage ? (
      <Image 
        src={optimizedImage} 
        alt={post.data.title} 
        class="featured-image" 
        widths={[600, 900, 1200]}
        sizes="(max-width: 600px) 100vw, 600px"
      />
    ) : post.data.image ? (
      <img 
        src={post.data.image} 
        alt={post.data.title} 
        class="featured-image"
        loading="lazy"
      />
    ) : null}
    <Button variant="secondary" href={BASE_URL + ROUTES.gallery}>Back to Photo Gallery</Button>
  </InteriorPage>
</Layout>

<style>
  img {
    inline-size: 100%;
    block-size: auto;
    margin-block-end: 2rem;
  }
</style>
